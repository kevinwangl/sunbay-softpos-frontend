# 🔒 安全评分计算模型

## 概述

安全评分是衡量设备安全状态的核心指标，采用多维度加权计算模型，综合评估设备的安全风险等级。

## 📊 计算模型

### 评分公式

```
安全评分 = Root检测得分 + Hook检测得分 + 调试模式检测得分 + TEE完整性检测得分
```

### 权重分配

| 检测项 | 权重 | 说明 |
|--------|------|------|
| **Root检测** | 30% (30分) | 检测设备是否获取Root权限 |
| **Hook检测** | 25% (25分) | 检测是否存在Hook框架 |
| **调试模式检测** | 20% (20分) | 检测设备是否处于调试模式 |
| **TEE完整性检测** | 25% (25分) | 验证可信执行环境完整性 |

**总分：100分**

## 🎯 评分标准

### 等级划分

| 等级 | 分数范围 | 标签 | 颜色 | 说明 | 建议操作 |
|------|----------|------|------|------|----------|
| **优秀** | 80-100 | 优秀 | 绿色 | 设备安全状态良好 | 可正常使用 |
| **良好** | 60-79 | 良好 | 蓝色 | 设备基本安全 | 建议关注 |
| **警告** | 40-59 | 警告 | 黄色 | 存在安全风险 | 需要处理 |
| **危险** | 0-39 | 危险 | 红色 | 严重安全问题 | 禁止交易 |

## 🔍 检测项详解

### 1. Root检测 (30分)

**检测目标**: 设备是否获取Root/越狱权限

**评分规则**:
- ✅ 未检测到Root: **30分**
- ❌ 检测到Root: **0分**

**风险说明**:
- Root权限可绕过系统安全机制
- 可能导致敏感数据泄露
- 增加恶意软件感染风险

**检测方法**:
- 检查su二进制文件
- 检测Root管理应用（Magisk、SuperSU等）
- 验证系统分区完整性

### 2. Hook检测 (25分)

**检测目标**: 是否存在Hook框架（Xposed、Frida等）

**评分规则**:
- ✅ 未检测到Hook框架: **25分**
- ❌ 检测到Hook框架: **0分**

**风险说明**:
- Hook框架可拦截和修改应用行为
- 可能窃取敏感信息
- 可篡改交易数据

**检测方法**:
- 检测Xposed框架
- 检测Frida服务
- 检查进程注入痕迹

### 3. 调试模式检测 (20分)

**检测目标**: 设备是否处于调试模式

**评分规则**:
- ✅ 未处于调试模式: **20分**
- ❌ 处于调试模式: **0分**

**风险说明**:
- 调试模式可能被用于逆向分析
- 增加代码注入风险
- 可能泄露运行时信息

**检测方法**:
- 检查USB调试状态
- 检测调试器连接
- 验证应用调试标志

### 4. TEE完整性检测 (25分)

**检测目标**: 可信执行环境（TEE）的完整性

**评分规则**:
- ✅ TEE完整性验证通过: **25分**
- ❌ TEE完整性验证失败: **0分**

**风险说明**:
- TEE是密钥存储和加密运算的核心
- TEE被破坏将导致密钥泄露
- 影响整个支付系统的安全性

**检测方法**:
- 验证TEE证书链
- 检查TEE固件版本
- 执行TEE完整性测试

## 📈 评分示例

### 示例1: 优秀设备 (95分)

| 检测项 | 状态 | 得分 |
|--------|------|------|
| Root检测 | ✅ 通过 | 30 |
| Hook检测 | ✅ 通过 | 25 |
| 调试模式检测 | ✅ 通过 | 20 |
| TEE完整性检测 | ✅ 通过 | 20 (扣5分：固件版本较旧) |
| **总分** | | **95** |

**评级**: 优秀 ✅  
**建议**: 可正常使用，建议更新TEE固件

### 示例2: 警告设备 (55分)

| 检测项 | 状态 | 得分 |
|--------|------|------|
| Root检测 | ❌ 失败 | 0 |
| Hook检测 | ✅ 通过 | 25 |
| 调试模式检测 | ✅ 通过 | 20 |
| TEE完整性检测 | ✅ 通过 | 10 (扣15分：证书链异常) |
| **总分** | | **55** |

**评级**: 警告 ⚠️  
**建议**: 检测到Root权限，建议暂停使用并通知商户

### 示例3: 危险设备 (20分)

| 检测项 | 状态 | 得分 |
|--------|------|------|
| Root检测 | ❌ 失败 | 0 |
| Hook检测 | ❌ 失败 | 0 |
| 调试模式检测 | ✅ 通过 | 20 |
| TEE完整性检测 | ❌ 失败 | 0 |
| **总分** | | **20** |

**评级**: 危险 🚫  
**建议**: 立即禁止交易，吊销设备证书

## 🎨 可视化展示

### 组件功能

安全评分详情组件 (`SecurityScoreDetail`) 提供：

1. **总分展示**
   - 大号数字显示总分
   - 颜色编码（绿/蓝/黄/红）
   - 等级标签
   - 进度条可视化

2. **计算公式说明**
   - 显示评分公式
   - 展示各项权重

3. **各项指标详情**
   - 每项检测的通过/失败状态
   - 每项的得分和满分
   - 检测详情说明
   - 单项进度条

4. **评分标准说明**
   - 四个等级的分数范围
   - 每个等级的含义和建议

### 使用示例

```typescript
import SecurityScoreDetail from '@/components/devices/SecurityScoreDetail';

// 在设备详情页使用
<SecurityScoreDetail 
  score={device.securityScore} 
  healthCheck={latestHealthCheck}
/>
```

## 🔄 动态评分

### 实时更新

- 每次健康检查后重新计算评分
- 评分变化会触发告警通知
- 历史评分趋势可视化

### 评分阈值

| 场景 | 阈值 | 动作 |
|------|------|------|
| 交易授权 | ≥ 60分 | 允许交易 |
| 交易授权 | < 60分 | 拒绝交易 |
| 设备审批 | ≥ 80分 | 自动通过 |
| 设备审批 | 60-79分 | 人工审核 |
| 设备审批 | < 60分 | 自动拒绝 |
| 告警触发 | < 60分 | 发送告警 |
| 自动暂停 | < 40分 | 自动暂停设备 |

## 📊 统计分析

### 评分分布

系统提供评分分布统计：
- 优秀设备数量和占比
- 良好设备数量和占比
- 警告设备数量和占比
- 危险设备数量和占比

### 趋势分析

- 设备评分历史趋势
- 平均评分变化
- 异常评分波动检测

## 🔧 模型优化

### 权重调整

根据实际运营数据，可以调整各项权重：

```typescript
const SCORE_WEIGHTS: ScoreWeights = {
  root: 30,   // 可调整
  hook: 25,   // 可调整
  debug: 20,  // 可调整
  tee: 25,    // 可调整
};
```

### 扩展检测项

未来可以增加更多检测维度：
- 应用完整性检测
- 网络环境检测
- 地理位置风险
- 设备信誉评分

## 📝 最佳实践

1. **定期检查**: 建议每次交易前进行健康检查
2. **阈值设置**: 根据业务需求设置合理的评分阈值
3. **告警响应**: 及时处理低分设备的告警
4. **数据分析**: 定期分析评分分布和趋势
5. **模型优化**: 根据实际情况调整权重和阈值

## 🎯 总结

安全评分模型通过多维度检测和加权计算，为设备安全状态提供量化评估。清晰的可视化展示帮助运营人员快速了解设备风险，做出正确的决策。

---

**设计原则**: 科学 · 透明 · 可操作 · 可扩展
